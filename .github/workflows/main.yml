name: Auto-Build CoreDNS with Fanout
on:
  schedule:
    - cron: '0 0 * * *'  # runs daily at midnight
  workflow_dispatch:  # Manual execution allowed

env:
  # github.repository as <account>/<repo>
  IMAGE_NAME: ${{ github.repository }}
  

jobs:
  # This job retrieves the latest release tags from CoreDNS and Fanout,
  # and then combines them (e.g. "v1.12.1-v1.11.3") to be used as part
  # of the Docker image tag.
  get-release-tags:
    name: Get Combined Release Tags
    runs-on: ubuntu-latest
    outputs:
      combined_release: ${{ steps.combine.outputs.combined_release }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Get Latest CoreDNS Release Tag
        id: coredns_release
        uses: actions/github-script@v6
        with:
          script: |
            // Call GitHub API to get the latest release for CoreDNS
            const { data } = await github.rest.repos.getLatestRelease({
              owner: 'coredns',
              repo: 'coredns'
            });
            core.setOutput('tag', data.tag_name);

      - name: Get Latest Fanout Release Tag
        id: fanout_release
        uses: actions/github-script@v6
        with:
          script: |
            // Call GitHub API to get the latest release for Fanout
            const { data } = await github.rest.repos.getLatestRelease({
              owner: 'networkservicemesh',
              repo: 'fanout'
            });
            core.setOutput('tag', data.tag_name);

      - name: Combine Release Tags
        id: combine
        run: |
          # Combine both tags with a hyphen separator (e.g. "v1.12.1-v1.11.3")
          COMBINED_RELEASE_TAG="${{ steps.coredns_release.outputs.tag }}-${{ steps.fanout_release.outputs.tag }}"
          echo "Combined Release Tag: ${COMBINED_RELEASE_TAG}"
          echo "combined_release=${COMBINED_RELEASE_TAG}" >> $GITHUB_OUTPUT
#          echo "COMBINED_RELEASE_TAG=${COMBINED_RELEASE_TAG}" >> $GITHUB_ENV
  
  # This job builds the Go binary and Docker image for each architecture.
  # The matrix strategy runs one job for "amd64" and another for "arm64".
  build:
    name: Build and Push Docker Images
    needs: get-release-tags
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    env:
      COMBINED_RELEASE_TAG: ${{ needs.get-release-tags.outputs.combined_release }}
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
  
      - name: Install Dependencies
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y golang make

      - name: Get CoreDNS & Plugin
        run: |
          git clone https://github.com/coredns/coredns.git
          cd coredns
          echo "fanout:github.com/networkservicemesh/fanout" >> plugin.cfg

      - name: Build CoreDNS
        run: |
          cd coredns
          make

      # Set up BuildKit Docker container builder to be able to build
      # multi-platform images and export cache
      # https://github.com/docker/setup-buildx-action
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0
        
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        id: push
        uses: docker/build-push-action@0565240e2d4ab88bba5387d719585280857ece09 # v5.0.0
        with:
          context: coredns/
          file: coredns/Dockerfile
          push: true
          # Build for the target platform. In this case, our Dockerfile simply copies the precompiled binary.
          platforms: "linux/${{ matrix.arch }}"
          tags: |
            tomtonic/coredns-fanout:${{ env.COMBINED_RELEASE_TAG }}-${{ matrix.arch }}
            tomtonic/coredns-fanout:latest-${{ matrix.arch }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
